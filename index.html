<html>

<style>
    table,
    th,
    td {
        border: 1px solid black;
        border-collapse: collapse;
        border-spacing: 5;
    }

    td {
        padding: 5px;
        padding-left: 100px;
    }
</style>

<head>
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous" />
    <script type="module">

        //I've never written js or html before, so sorry if it's ugly! XD

        ///// 'LOOKUP' is the main function, and the only wasm funcion used
        import init, { lookup } from './pkg/senor_borroso.js';
        async function run() {
            await init();
            var textInput = document.getElementById('nameInput');
            const updateTable = function () {
                var l;
                var input = $("#nameInput").val();
                var before = window.performance.now();

                //We actually run the lookup 25 times per keystroke to be able to benchmark it
                for (let i = 0; i < 25; i++) {

                    l = lookup(input);

                }

                var after = window.performance.now();

                var myList = JSON.parse(l);

                function buildHtmlTable(selector) {
                    var columns = addAllColumnHeaders(myList, selector);

                    for (var i = 0; i < myList.length; i++) {
                        var row$ = $('<tr/>');
                        for (var colIndex = 0; colIndex < columns.length; colIndex++) {
                            var cellValue = myList[i][columns[colIndex]];
                            if (cellValue == null) cellValue = "";
                            row$.append($('<td/>').html(cellValue));
                        }
                        $(selector).append(row$);
                    }
                }


                function addAllColumnHeaders(myList, selector) {
                    var columnSet = [];
                    var headerTr$ = $('<tr/>');

                    for (var i = 0; i < myList.length; i++) {
                        var rowHash = myList[i];
                        for (var key in rowHash) {
                            if ($.inArray(key, columnSet) == -1) {
                                columnSet.push(key);
                                headerTr$.append($('<th/>').html(key));
                            }
                        }
                    }
                    $(selector).append(headerTr$);

                    return columnSet;
                }
                document.getElementById("results").innerHTML = "";
                buildHtmlTable(document.getElementById("results"))


                var time = (((after - before) / 25) * 1000).toFixed(0);
                document.getElementById("timing").innerText = `WASM lookup took ${time} microseconds (μs).`

            }
            textInput.addEventListener("keypress", updateTable)
            textInput.addEventListener("keydown", updateTable)
        }
        run();
    </script>
</head>

<body>
    <div class="row">
        <div class="col-sm-4"></div>
        <div class="col-sm-4">
            <b>Fuzzy language lookup with WASM</b>
        </div>
        <div class="col-sm-4"></div>
    </div>
    <hr />

    <p>This is a fun demo to play with improving user experience through approximate nearest neighbor search on the
        front end. It uses very fast web assembly compiled from a single rust entry point and everything runs in the
        browser. It’s actually fast enough that building the entire search index for all 1,040 language names only takes
        a few milliseconds. Feel free to contact me with any questions. All code is available <a
            href="https://github.com/Lambda-Logan/fuzzy_lang_search">on github.</a> </p>
    <p>Even though it’s only about 3mb and lightning fast, there are still many improvements that can be made. But for
        now it works very well and is VERY robust against typos!!</p>


    <div class="row">
        <div class="col-sm-2"></div>
        <div id="ques" class="col-sm-4"><b>Type a language name with with some spelling errors:</b></div>
        <div class="col-sm-4"></div>
        <div class="col-sm-2"></div>
    </div>
    <div class="row">
        <div class="col-sm-2"></div>
        <div class="col-sm-4">
            <input type="text" id="nameInput" placeholder="enxglxish" , value="enxglxish">
        </div>
        <div class="col-sm-4">
            <!-- <button class="bg-light" id="buttonOne">¡Search languages!</button> -->
        </div>
        <div class="col-sm-2"></div>
    </div>
    <br>
    <div id="timing"></div>
    </br>
    <div id="results"></div>
</body>
<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.js"
    integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>

</html>